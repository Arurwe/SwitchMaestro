services:
  traefik:
    image: traefik:v3.2
    ports:
      - "443:443"
    networks:
      development:
    volumes:
      # Mount the Docker socket as read-only so Traefik can listen to events
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./.infrastructure/conf/traefik/dev/traefik.yml:/traefik.yml:ro
      - ./.infrastructure/conf/traefik/dev/traefik-certs.yml:/traefik-certs.yml
      - ./.infrastructure/conf/traefik/dev/certificates/:/certificates

  php:
    build:
      target: development
      args:
        USER_ID: ${SPIN_USER_ID}
        GROUP_ID: ${SPIN_GROUP_ID}
    environment:
      SSL_MODE: "full"
    volumes:
      - .:/var/www/html/
      - ./storage:/var/www/html/storage
    networks:
      - development
    depends_on:
      - traefik
      - postgres
      - redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.laravel.rule=HostRegexp(`laravel.dev.test`)"
      - "traefik.http.routers.laravel.entrypoints=websecure"
      - "traefik.http.routers.laravel.tls=true"
      - "traefik.http.services.laravel.loadbalancer.server.port=8443"
      - "traefik.http.services.laravel.loadbalancer.server.scheme=https"
  scheduler:
      build:
        target: development
        args:
          USER_ID: ${SPIN_USER_ID}
          GROUP_ID: ${SPIN_GROUP_ID}         
      command: [ "php", "/var/www/html/artisan", "schedule:work" ]
      stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
      volumes:
        - .:/var/www/html/
      networks:
        - development
      depends_on:
        - php
        - postgres
        - redis

  queue:
    build:
      target: development
      args:
        USER_ID: ${SPIN_USER_ID}
        GROUP_ID: ${SPIN_GROUP_ID}
    environment:
      PHP_MEMORY_LIMIT: "2048M"
    command: [ "php", "/var/www/html/artisan", "queue:listen" ]
    stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
    healthcheck:
      # This is our native healthcheck script for the queue
      test: [ "CMD", "healthcheck-queue" ]
      start_period: 10s
    volumes:
      - .:/var/www/html/
    networks:
      - development
    depends_on:
      - php
      - postgres
      - redis
  redis:
    command: "redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}"
    volumes:
      - ./.infrastructure/volume_data/redis/data:/data
    ports:
      - "6379:6379"
    networks:
      - development
  postgres:
    networks:
      - development
    volumes:
      - ./.infrastructure/volume_data/postgres/database_data/:/var/lib/postgresql
    environment:
      PGPASSWORD: '${DB_PASSWORD:-secret}'
      POSTGRES_DB: '${DB_DATABASE}'
      POSTGRES_USER: '${DB_USERNAME}'
      POSTGRES_PASSWORD: '${DB_PASSWORD:-secret}'
    ports:
      - "5432:5432"

  node:
    image: node:20
    user: ${SPIN_USER_ID}:${SPIN_GROUP_ID}
    command: "yarn run dev"
    volumes:
      - .:/usr/src/app/
    working_dir: /usr/src/app/
    depends_on:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vite.rule=HostRegexp(`vite.dev.test`)"
      - "traefik.http.routers.vite.entrypoints=websecure"
      - "traefik.http.routers.vite.tls=true"
      - "traefik.http.services.vite.loadbalancer.server.port=5173"
      - "traefik.http.services.vite.loadbalancer.server.scheme=https"
    networks:
      - development


  mailpit:
    image: axllent/mailpit
    networks:
      - development
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailpit.rule=Host(`mailpit.dev.test`)"
      - "traefik.http.routers.mailpit.entrypoints=websecure"
      - "traefik.http.routers.mailpit.tls=true"
      - "traefik.http.services.mailpit.loadbalancer.server.port=8025"
      - "traefik.http.services.mailpit.loadbalancer.server.scheme=http"
    depends_on:
      - traefik
  api:
    build:
      context: ./api-python 
      dockerfile: Dockerfile
      target: development 
      args:
        USER_ID: ${SPIN_USER_ID}
        GROUP_ID: ${SPIN_GROUP_ID}
    volumes:
      - ./api-python:/app
    networks:
      - development
    depends_on:
      - traefik
      - postgres
      - redis
    environment:
      CELERY_BROKER_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      DATABASE_URL: "postgresql://${DB_USERNAME}:${DB_PASSWORD}@postgres:5432/${DB_DATABASE}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.dev.test`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      - "traefik.http.services.api.loadbalancer.server.scheme=http"
  celery-worker:
    build:
      context: ./api-python
      dockerfile: Dockerfile
      target: development
    command: ["celery", "-A", "app.worker.celery_app", "worker", "--loglevel=info"] 
    volumes:
      - ./api-python:/app
    networks:
      - development
    depends_on:
      - redis 
      - postgres 
      - api 
    environment:
      CELERY_BROKER_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      DATABASE_URL: "postgresql://${DB_USERNAME}:${DB_PASSWORD}@postgres:5432/${DB_DATABASE}"
    restart: unless-stopped

networks:
  development: